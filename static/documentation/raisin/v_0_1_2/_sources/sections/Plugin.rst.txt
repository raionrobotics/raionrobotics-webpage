#############################
Plugin
#############################

For incorporating advanced features like state estimation and mapping, Raisin supports plugins.
Plugins are dynamically loaded shared libraries, and ``advance()`` is called at a configured rate
(Hz). There are three common ways to load a plugin:

#. Load by ``raisin_raibo2_node``: This method loads the plugin from the start of the executable.

#. Load by ``controller``: This method loads the plugin concurrently when the controller is loaded.

#. Load by ``plugin``: This method loads other plugin concurrently when the plugin is loaded.

Configuration in params.yaml
=============================

Plugins are declared under a top-level ``plugin`` section in the package parameters (for example,
``raisin_raibo2/config/params.yaml``). Use the *base* plugin name (without the ``raisin_`` prefix
and ``_plugin`` suffix). The rate is in Hz:

.. code-block:: xml

  plugin:
    d430:
      rate: 1
      instances: [d430_front, d430_rear]
      active_instances_at_start: [d430_front, d430_rear]
    grid_mapping:
      rate: 5

In this configuration:

* **name**: The base plugin name (``d430`` -> ``raisin_d430_plugin``).
* **rate**: How often, in Hz, the plugin's ``advance()`` function should be called. If the rate is
  ``<= 0``, the plugin is loaded but no periodic loop is started.
* **instances**: Optional list of instance titles to use when creating multiple instances.
* **active_instances_at_start**: Optional list of instance titles to load automatically at startup.

A plugin stores its subscribers, which are packages (for example ``raisin_raibo2_node``,
``controller``, and other ``plugin`` instances) that configured the plugin.
A plugin is unloaded if

#. There's no subscriber anymore

#. Another plugin with same pluginType is loaded(refer to the ``PluginType``)

If the new plugin's type is ``SLAM``, existing ``STATE_ESTIMATOR`` and ``MAPPING`` plugins are also
unloaded to avoid conflicts.

Instance and loading behavior
==============================

* ``PluginManager::load`` accepts a base plugin name and an optional instance title. If a title is
  not provided, it will use the first available configured instance title or fall back to
  ``<plugin_name>:<n>``.
* The plugin package parameters can set ``allow_multiple_instances`` to control whether multiple
  instances of the same base plugin may coexist.
* A plugin package can declare dependent plugins under its own ``plugin`` section; these are loaded
  automatically when the parent plugin is loaded.
* The periodic loop is scheduled on the thread group specified by ``thread_group`` in the plugin
  package parameters.

Unload behavior
================

Plugins can be unloaded explicitly or automatically:

* ``PluginManager::unload(<identifier>)`` accepts either the instance title or the base plugin
  name. If multiple instances exist for a base name, you must specify a title.
* ``PluginManager::removeSubscriber(subscriber_id)`` removes the subscriber from every loaded
  plugin. If a plugin has no remaining subscribers, it is unloaded automatically.
* The plugin manager periodically checks ``Plugin::shouldTerminate()``; any plugin that returns
  true is unloaded on the next check.

Unload flow details:

* The plugin's periodic loop is stopped first.
* The shared library is released only when no remaining instances reference it.
* When unloading a plugin, the manager also detaches it from dependent plugins that listed it as a
  subscriber.

For implementing plugins in Raisin, it's important to adhere to the naming convention specified.
Each plugin should be named following the pattern ``raisin_**_plugin``, where ** represents a
descriptive part of the plugin's functionality.

For practical implementation examples, refer to the :download:`raisin_example_plugin.zip <../example/raisin_example_plugin.zip>`.

Factory functions
==================

Plugin shared libraries can expose any of the following factory symbols. The loader tries the most
specific signature first and falls back to ``create``:

* ``create_with_owner_title_robot``
* ``create_with_owner_and_title``
* ``create_with_title``
* ``create``

API
====

.. doxygenclass:: raisin::plugin::PluginManager
   :members:
   :protected-members:

.. doxygenclass:: raisin::plugin::Plugin
   :members:
   :protected-members:

.. doxygenenum:: raisin::plugin::PluginType
